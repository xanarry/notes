# 在线程序评测系统

## 评测机

评测机的工作就是判定用户提交的题解代码是否正确以及对内存和时间的消耗是否在限定范围内。

以C语言的用户代码为例，当用户提交某一个题目的题解代码之后，评测机主要经过以下三个流程，分别是：编译、运行、检查结果。

### 编译过程

首先判定程序通过编译的条件就是GCC的返回值为0，然后警告和错误信息通过标准错误输出。

评测机通过网络收到web服务器发送过来的代码字符流之后，流程如下：

- 将代码保存为磁盘文件main.c，
- 评测机创建一个编译子进程，并把子进程的标准错误通过管道重定向到评测机的标准输入，然后在子进程中执行GCC编译main.c。
- 待子进程运行完毕之后，评测机从管道中读取警告和错误信息。并获取（通过`WEXITSTATUS(status)`）编译子进程的返回值，如果返回值为0，则进行下一步的执行过程；返回为1就直接返回编译错误的信息，不再往后运行。

### 运行过程

运行程序同样也是创建一个子进程，编译的时候子进程运行

GCC，这里就是运行刚刚编译完成的用户程序。

在开始运行用户程序之前，需要对该进程的运行时间、输出文件大小设置一个限定值。运行过程中如果对应属性超过了这个值就会给评测机发出相应信号。

然后使用ptrace让子进程单步执行，以便评测机能跟踪子进程的运行情况。当评测机收到子进程资源消耗超过限定值或者发生错误的时候，比如除零、内存访问异常等，就终止本次运行。

#### 内存获取

Linux会为每个进程在`/proc/pid/`目录下面创建一系列描述该进程的文件，该目录下的`status`文件就记录了进程的内存使用情况。在子进程每一步的运行过程中，评测机从该文件读出VmPeak（虚拟内存使用峰值）这个属性对于的值，并更新运行过程中所产生的最大值，作为程序的内存消耗。

#### 时间获取

子进程运行结束之后，会把一些资源消耗的情况记录在一个`rusage`结构体，其中包括时间消耗，IO读写次数，缺页中断次数，发送、接收到多少次信号等。

评测机就从这个结构体把时间消耗读取出来。



### 结果检查

答案检查的方式就是对比用户输出的结果和标准结果。

有三种结果：

accept：删除用户输出和标准答案的行末空白，对比一样；

presentation error：没有accept，除去所有空格、tab、换行，对比用户答案和标准答案一致。

wrong answer：以上都不满足，就是wrong answer。



## web服务







# 语音识别

使用的线程池为`newFixedThreadPool()`，调用该`Executors.newFixedThreadPool(nThreads);`相当于是调用的

```java
new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<Runnable>());
```

即核心线程池大小与最大大线程池大小不均为nThreads，一旦线程数达到核心线程数之后，线程就会维持这个数目。且线程池中空闲的工作线程不会被自动清理，以无界阻塞队列为缓存队列。



nThread在项目中设置的值为识别服务器的数量。





使用的线程池为`newCachedThreadPool()`，调用该`Executors.newCachedThreadPool();`相当于是调用的

```java
new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue<Runnable>());
```

即核心线程池大小为0，最大线程池大小不受限制，工作线程最大空闲时间允许为60秒，